/**
 * Mowla javascript template 'engine'.
 *
 * Licensed under the shizzle dizzle MIT license.
 *
 * @author MArc Schmidt <https://github.com/MArcJ>
 */
(function () {
    var cache = {};
    this.mowla = {};
    this.mowla.fetch = function (pSource, pData) {
        if (!pData) {
            pData = window;
        }
        if (typeof(pSource) == 'object' &&
            'innerHTML'in pSource) {
            return mowla.fetch(mowla.htmlEntities(pSource.innerHTML), pData);
        }
        return(cache[pSource] || (cache[pSource] = mowla.compile(pSource)))(pData)
    };
    this.mowla.render = function (pSource, pData) {
        pSource.innerHTML = mowla.fetch(pSource, pData)
    };
    this.mowla.compile = function (pSource) {
        try {
            return new Function('data', code = mowla.getCode(pSource))
        } catch (e) {
            if (typeof(console) != 'undefined') {
                console.log('[mowla.compile] error in following generated code');
                console.log(code)
            }
            throw e
        }
    };
    this.mowla.getCode = function (pSource) {
        var r = function (v) {
            var matches = v.match(/^\{(.*)$/gm), i;
            for (i = matches.length; i >= 0; i--) {
                if (matches[i]) {
                    v = v.replace(matches[i],
                        matches[i].replace(/\\\\\'/g, '\'').replace(/\\\\\{/g, '{').replace(/\\\\\}/g, '}'))
                }
            }
            return v.replace(/\\'/g, '\'')
        };
        return'with(data){ var ___ = \'' +
            r(pSource.replace(/'/g, '\\\'').replace(/\\/g, '\\\\').replace(/\\\n/g, '\\\\\n').replace(/([^\\])\{/g,
                "$1\\\n{").replace(/([^\\])\}/g, "$1\\\n}")).replace(/^\{\/(if|for|while)\\\n\}/gm,
                    "'; } ___ += \'").replace(/^\{else\\\n\}/gm, "'; } else { ___ += \'").replace(/^\{\/if\\\n\}/gm,
                    "'; }; ___ += \'").replace(/^\{\/foreach\\\n\}/gm,
                    "'; }); ___ += \'").replace(/^\{foreach ([^\}]*) as ([^\}]*)\\\n\}/gm,
                    "'; mowla.forEach($1, function($2, first, last, index){ ___ += \'").replace(/^\{call (.*)\\\n\}/gm,
                    "'; $1; ___ += \'").replace(/^\{html (.*)\\\n\}/gm,
                    "'; ___ += ($1); ___ += \'").replace(/^\{(if|for|while) ([^}]*)\\\n\}/gm,
                    "'; $1 ($2) { ___ += \'").replace(/^\{var ([^}]*)\\\n\}/gm, "'; var $1; ___ += \'").replace(/^\{/gm,
                    "'; ___ += mowla.escape(").replace(/^\}/gm, "); ___ += \'").replace(/([^\\])\\\n/g,
                    "$1").replace(/\\\n/g, "\n").replace(/\n/g, "'+\"\\n\"\n+'") + '\'; return ___;}'
    };
    this.mowla.length = function (pArObj) {
        if (Object.prototype.toString.call(pArObj) === '[object Array]') {
            return pArObj.length;
        }
        if ('keys'in Object) {
            return Object.keys(pArObj).length;
        } else {
            var size = 0;
            for (var i in pArObj) {
                if (pArObj.hasOwnProperty(i)) {
                    size++;
                }
            }
            return size
        }
    };
    this.mowla.forEach = function (pArObj, pCb) {
        var i = 0;
        var length = mowla.length(pArObj);
        if (Object.prototype.toString.call(pArObj) !== '[object Array]') {
            for (i in pArObj) {
                if (pArObj.hasOwnProperty(i)) {
                    pCb(pArObj[i], i == 0, i == length - 1, (i++) + 1)
                }
            }
        } else {
            for (i = 0; i < length; i++) {
                pCb(pArObj[i], (i == 0) ? true : false, i == length - 1, i + 1)
            }
        }
    };
    this.mowla.escape = function (pValue) {
        return typeof(pValue) == 'string' ? pValue.replace(/</g, '&lt;').replace(/>/g, '&gt;') : pValue
    };
    this.mowla.htmlEntities = function (pHtml) {
        return pHtml.replace(/&amp;/g, '&').replace(/&gt;/g, '>').replace(/&lt;/g, '<')
    }
})();